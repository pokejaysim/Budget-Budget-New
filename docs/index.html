<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Buddy</title>
    <!-- Using Tailwind CDN for simplicity in this single-file app -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        @media (min-width: 640px) {
            .chart-container {
                height: 300px;
            }
        }
        /* Mobile-specific improvements */
        @media (max-width: 639px) {
            .mobile-full-width {
                width: 100vw;
                margin-left: -1rem;
                margin-right: -1rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .dropdown-mobile {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                top: auto;
                max-height: 50vh;
                border-radius: 1rem 1rem 0 0;
                animation: slideUp 0.3s ease-out;
            }
            /* Improve touch targets */
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }
            /* Better scrolling */
            .mobile-scroll {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior-y: contain;
            }
            /* Bottom navigation padding */
            .pb-safe {
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
        }
        /* Prevent text selection on buttons */
        button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Improve dropdown visibility */
        .dropdown-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp, setDoc, updateDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        // Firebase configuration - embedded directly
        const firebaseConfig = {
            apiKey: "AIzaSyAVmyc6PDfrVNvNLCjpJ5Q6mgf_OtABCjk",
            authDomain: "new-budget-buddy.firebaseapp.com",
            projectId: "new-budget-buddy",
            storageBucket: "new-budget-buddy.firebasestorage.app",
            messagingSenderId: "158961105774",
            appId: "1:158961105774:web:abc0595f893b2715d59f7f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentUser = null;
        let allExpenses = []; // All expenses for the user
        let expenses = []; // Filtered expenses
        let monthlyBudget = 2000;
        let billingCycleDay = 11; // Day of month when cycle closes
        let billingCycleStart = new Date().toISOString().split('T')[0];
        let unsubscribeExpenses = null;
        let unsubscribeSettings = null;
        let currentView = 'current'; // 'current', 'monthly', 'yearly', 'custom', 'customYear', 'billingCycle'
        let searchQuery = '';
        let selectedCategory = '';
        let selectedMonth = null; // Format: 'YYYY-MM'
        let selectedYear = null; // Format: YYYY
        let selectedBillingCycle = null; // Format: 'YYYY-MM-DD' (start date of cycle)
        let charts = {}; // Store chart instances
        let categories = []; // Will be loaded from Firebase
        let unsubscribeCategories = null;

        // Default categories (used as fallback and for new users)
        const defaultCategories = [
            { id: 'food', name: 'Food', emoji: '🍔', color: 'bg-orange-500', chartColor: '#f97316' },
            { id: 'groceries', name: 'Groceries', emoji: '🛒', color: 'bg-green-500', chartColor: '#10b981' },
            { id: 'transport', name: 'Transport', emoji: '🚗', color: 'bg-blue-500', chartColor: '#3b82f6' },
            { id: 'shopping', name: 'Shopping', emoji: '🛍️', color: 'bg-pink-500', chartColor: '#ec4899' },
            { id: 'bills', name: 'Bills', emoji: '📄', color: 'bg-gray-500', chartColor: '#6b7280' },
            { id: 'fun', name: 'Fun', emoji: '🎬', color: 'bg-purple-500', chartColor: '#a855f7' },
            { id: 'other', name: 'Other', emoji: '📦', color: 'bg-yellow-600', chartColor: '#eab308' }
        ];

        // Initialize auth listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                subscribeToUserData();
                showApp();
            } else {
                if (unsubscribeExpenses) unsubscribeExpenses();
                if (unsubscribeSettings) unsubscribeSettings();
                if (unsubscribeCategories) unsubscribeCategories();
                categories = [];
                showLogin();
            }
        });

        function calculateCurrentCycle(cycleDay = billingCycleDay, referenceDate = null) {
            const today = referenceDate || new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            let cycleStart, cycleEnd;
            
            // Helper function to get the actual day in a month (handles months with < 31 days)
            function getValidDayInMonth(year, month, day) {
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                return Math.min(day, lastDayOfMonth);
            }
            
            // Cycle starts on the day after closing (e.g., 12th if closing is 11th)
            const cycleStartDay = cycleDay + 1;
            
            if (currentDay >= cycleStartDay) {
                // We're in a cycle that started this month
                const validStartDay = getValidDayInMonth(currentYear, currentMonth, cycleStartDay);
                const validEndDay = getValidDayInMonth(currentYear, currentMonth + 1, cycleDay);
                
                cycleStart = new Date(currentYear, currentMonth, validStartDay);
                cycleEnd = new Date(currentYear, currentMonth + 1, validEndDay);
            } else {
                // We're in a cycle that started last month
                const validStartDay = getValidDayInMonth(currentYear, currentMonth - 1, cycleStartDay);
                const validEndDay = getValidDayInMonth(currentYear, currentMonth, cycleDay);
                
                cycleStart = new Date(currentYear, currentMonth - 1, validStartDay);
                cycleEnd = new Date(currentYear, currentMonth, validEndDay);
            }
            
            return {
                start: cycleStart,
                end: cycleEnd,
                startStr: cycleStart.toISOString().split('T')[0],
                endStr: cycleEnd.toISOString().split('T')[0]
            };
        }

        function getRemainingDaysInCycle() {
            const cycle = calculateCurrentCycle();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(cycle.end);
            endDate.setHours(0, 0, 0, 0);
            const diffTime = endDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function subscribeToUserData() {
            // Initialize categories with defaults immediately to prevent undefined errors
            categories = [...defaultCategories];
            
            // Subscribe to user settings
            const settingsRef = doc(db, 'userSettings', currentUser.uid);
            unsubscribeSettings = onSnapshot(settingsRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    monthlyBudget = data.monthlyBudget || 2000;
                    billingCycleDay = data.billingCycleDay || 11;
                    
                    // Auto-calculate current cycle based on cycle day
                    const currentCycle = calculateCurrentCycle(billingCycleDay);
                    billingCycleStart = currentCycle.startStr;
                }
                filterAndRender();
            });

            // Subscribe to user categories
            const categoriesRef = doc(db, 'userCategories', currentUser.uid);
            unsubscribeCategories = onSnapshot(categoriesRef, async (doc) => {
                if (doc.exists()) {
                    categories = doc.data().categories || defaultCategories;
                } else {
                    // Initialize with default categories for new users
                    categories = defaultCategories;
                    try {
                        await setDoc(categoriesRef, { categories: defaultCategories });
                    } catch (error) {
                        console.error('Error saving default categories:', error);
                        // Continue with default categories even if save fails
                    }
                }
                filterAndRender();
            }, (error) => {
                console.error('Error loading categories:', error);
                // Use default categories if there's an error
                categories = defaultCategories;
                filterAndRender();
            });

            // Subscribe to ALL expenses (not just current billing cycle)
            const q = query(
                collection(db, 'expenses'),
                where('userId', '==', currentUser.uid),
                orderBy('date', 'desc')
            );

            unsubscribeExpenses = onSnapshot(q, (snapshot) => {
                allExpenses = [];
                snapshot.forEach((doc) => {
                    const expenseData = doc.data();
                    const expense = {
                        id: doc.id,
                        ...expenseData,
                        date: expenseData.date.toDate().toISOString()
                    };
                    
                    // Debug: Check for expenses with missing categories
                    if (expense.category && !categories.find(c => c.id === expense.category)) {
                        console.warn('Expense has unknown category:', expense.id, 'Category ID:', expense.category);
                    }
                    
                    allExpenses.push(expense);
                });
                filterAndRender();
                checkBudgetAlert();
            });
        }

        function filterAndRender() {
            // Filter expenses based on current view and search
            expenses = filterExpenses(allExpenses);
            render();
        }

        function getAvailableMonths() {
            const months = new Set();
            allExpenses.forEach(expense => {
                const date = new Date(expense.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                months.add(monthKey);
            });
            return Array.from(months).sort().reverse();
        }

        function getAvailableYears() {
            const years = new Set();
            allExpenses.forEach(expense => {
                const date = new Date(expense.date);
                years.add(date.getFullYear());
            });
            return Array.from(years).sort().reverse();
        }

        function getAvailableBillingCycles() {
            if (allExpenses.length === 0) return [];
            
            const cycles = new Map();
            const sortedExpenses = [...allExpenses].sort((a, b) => new Date(a.date) - new Date(b.date));
            const oldestExpense = new Date(sortedExpenses[0].date);
            const newestExpense = new Date(sortedExpenses[sortedExpenses.length - 1].date);
            
            // Start from the oldest expense date
            let cycleDate = new Date(oldestExpense);
            
            while (cycleDate <= newestExpense) {
                const cycle = calculateCurrentCycle(billingCycleDay, cycleDate);
                const cycleKey = cycle.startStr;
                const cycleLabel = `${new Date(cycle.start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(cycle.end).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                
                cycles.set(cycleKey, cycleLabel);
                
                // Move to next month
                cycleDate.setMonth(cycleDate.getMonth() + 1);
            }
            
            // Add current cycle if not already included
            const currentCycle = calculateCurrentCycle(billingCycleDay);
            const currentKey = currentCycle.startStr;
            if (!cycles.has(currentKey)) {
                const currentLabel = `${new Date(currentCycle.start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(currentCycle.end).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} (Current)`;
                cycles.set(currentKey, currentLabel);
            }
            
            return Array.from(cycles.entries()).sort((a, b) => b[0].localeCompare(a[0]));
        }

        function filterExpenses(expenseList) {
            let filtered = [...expenseList];
            
            // Filter by view (date range)
            if (currentView === 'current') {
                const currentCycle = calculateCurrentCycle(billingCycleDay);
                filtered = filtered.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= currentCycle.start && expenseDate <= currentCycle.end;
                });
            } else if (currentView === 'custom' && selectedMonth) {
                // Filter by specific month
                const [year, month] = selectedMonth.split('-').map(Number);
                filtered = filtered.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getFullYear() === year && expenseDate.getMonth() === month - 1;
                });
            } else if (currentView === 'customYear' && selectedYear) {
                // Filter by specific year
                filtered = filtered.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getFullYear() === selectedYear;
                });
            } else if (currentView === 'billingCycle' && selectedBillingCycle) {
                // Filter by specific billing cycle
                const cycleStartDate = new Date(selectedBillingCycle);
                const cycle = calculateCurrentCycle(billingCycleDay, cycleStartDate);
                filtered = filtered.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= cycle.start && expenseDate <= cycle.end;
                });
            }
            
            // Filter by search query
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(expense => 
                    expense.description.toLowerCase().includes(query) ||
                    expense.amount.toString().includes(query) ||
                    (categories.find(c => c.id === expense.category)?.name || '').toLowerCase().includes(query)
                );
            }
            
            // Filter by category
            if (selectedCategory) {
                filtered = filtered.filter(expense => expense.category === selectedCategory);
            }
            
            return filtered;
        }

        function checkBudgetAlert() {
            if (currentView !== 'current') return;
            
            const currentCycle = calculateCurrentCycle(billingCycleDay);
            const cycleExpenses = allExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= currentCycle.start && 
                       expenseDate <= currentCycle.end &&
                       !expense.isRefund;
            });
            
            const totalSpent = cycleExpenses.reduce((sum, expense) => {
                return sum + (expense.isRefund ? -expense.amount : expense.amount);
            }, 0);
            const percentUsed = (totalSpent / monthlyBudget) * 100;
            
            if (percentUsed >= 100) {
                showBudgetNotification('danger', `Budget exceeded! You've spent $${totalSpent.toFixed(2)} of your $${monthlyBudget} budget.`);
            } else if (percentUsed >= 90) {
                showBudgetNotification('warning', `Warning: You've used ${percentUsed.toFixed(0)}% of your budget.`);
            }
        }

        function showBudgetNotification(type, message) {
            const existingNotification = document.getElementById('budget-notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.id = 'budget-notification';
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 animate-slide-up ${
                type === 'danger' ? 'bg-red-500 text-white' : 
                type === 'success' ? 'bg-green-500 text-white' : 'bg-yellow-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${type === 'success' ? 
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />' :
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />'
                        }
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function getMonthlyData() {
            const monthlyTotals = {};
            const now = new Date();
            
            // Initialize last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyTotals[key] = 0;
            }

            // Sum expenses by month
            allExpenses.forEach(expense => {
                const date = new Date(expense.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (monthlyTotals.hasOwnProperty(key)) {
                    monthlyTotals[key] += expense.amount;
                }
            });

            return monthlyTotals;
        }

        function getCategoryTrends() {
            const trends = {};
            const now = new Date();
            
            // Initialize categories for last 6 months
            categories.forEach(cat => {
                trends[cat.id] = {};
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    trends[cat.id][key] = 0;
                }
            });

            // Sum expenses by category and month
            allExpenses.forEach(expense => {
                const date = new Date(expense.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthStart = new Date(now.getFullYear(), now.getMonth() - 5, 1);
                
                if (date >= monthStart && trends[expense.category]) {
                    trends[expense.category][key] = (trends[expense.category][key] || 0) + expense.amount;
                }
            });

            return trends;
        }

        function showLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-md">
                        <div class="text-center mb-6 sm:mb-8">
                            <div class="inline-flex items-center justify-center w-14 h-14 sm:w-16 sm:h-16 bg-blue-100 rounded-full mb-4">
                                <span class="text-2xl sm:text-3xl">💳</span>
                            </div>
                            <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Budget Buddy</h1>
                            <p class="text-sm sm:text-base text-gray-600 mt-2" id="authTitle">Sign in to your account</p>
                        </div>

                        <div id="errorMessage"></div>

                        <!-- Google Sign In Button -->
                        <button onclick="handleGoogleSignIn()" type="button" class="w-full flex items-center justify-center gap-3 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                                <g fill="none" fill-rule="evenodd">
                                    <path d="M17.64 9.205c0-.639-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
                                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
                                    <path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.628 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                                </g>
                            </svg>
                            <span class="text-sm sm:text-base font-medium text-gray-700">Continue with Google</span>
                        </button>

                        <div class="relative my-6">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white text-gray-500">Or</span>
                            </div>
                        </div>

                        <form onsubmit="handleAuth(event, isSignUp)" id="authForm">
                            <div class="space-y-4">
                                <div>
                                    <input type="email" id="email" required 
                                        class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Email address">
                                </div>
                                <div>
                                    <input type="password" id="password" required 
                                        class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Password">
                                </div>
                                <button type="submit" id="authButton" 
                                    class="w-full bg-blue-600 text-white py-2 sm:py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                    Sign in
                                </button>
                            </div>
                        </form>

                        <p class="mt-4 text-center text-xs sm:text-sm text-gray-600">
                            <span id="authToggleText">Don't have an account?</span>
                            <button onclick="toggleAuthMode()" class="text-blue-600 hover:text-blue-700 font-medium">
                                <span id="authToggleButton">Sign up</span>
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }

        function showApp() {
            render();
        }

        function render() {
            // Calculate totals for current view
            const totalSpent = expenses.reduce((sum, expense) => {
                return sum + (expense.isRefund ? -expense.amount : expense.amount);
            }, 0);
            const budgetRemaining = monthlyBudget - totalSpent;
            const budgetPercentage = (totalSpent / monthlyBudget) * 100;

            // Get unique categories from expenses
            const expenseCategories = [...new Set(expenses.map(e => e.category))];

            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <!-- Header -->
                    <div class="bg-white shadow-sm border-b sticky top-0 z-10">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center justify-between h-14 sm:h-16">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl sm:text-2xl">💳</span>
                                    <h1 class="text-lg sm:text-xl font-bold text-gray-900">Budget Buddy</h1>
                                </div>
                                <div class="flex items-center gap-1 sm:gap-4">
                                    <button onclick="showCategoryManager()" class="p-2 sm:p-2 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation touch-target flex items-center justify-center">
                                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                                        </svg>
                                    </button>
                                    <button onclick="showBudgetModal()" class="p-2 sm:p-2 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation touch-target flex items-center justify-center">
                                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </button>
                                    <button onclick="handleLogout()" class="p-2 sm:p-2 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation touch-target flex items-center justify-center">
                                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-8">
                        <!-- Budget Overview -->
                        <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6 mb-4 sm:mb-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                                <h2 class="text-base sm:text-lg font-semibold text-gray-900 mb-2 sm:mb-0">
                                    ${currentView === 'current' ? 'Current Billing Cycle' : 
                                      currentView === 'custom' && selectedMonth ? `${new Date(selectedMonth + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}` :
                                      currentView === 'customYear' && selectedYear ? `Year ${selectedYear}` :
                                      currentView === 'billingCycle' && selectedBillingCycle ? (() => {
                                          const cycle = calculateCurrentCycle(billingCycleDay, new Date(selectedBillingCycle));
                                          return `${new Date(cycle.start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${new Date(cycle.end).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                                      })() :
                                      'All Time'}
                                </h2>
                                ${currentView === 'current' ? `
                                    <button onclick="handleResetBilling()" class="flex items-center gap-1 sm:gap-2 text-xs sm:text-sm text-blue-600 hover:text-blue-700">
                                        <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                        Reset cycle to today
                                    </button>
                                ` : ''}
                            </div>
                            
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4">
                                <div>
                                    <p class="text-xs sm:text-sm text-gray-600">Total Spent</p>
                                    <p class="text-lg sm:text-2xl font-bold text-gray-900">$${totalSpent.toFixed(2)}</p>
                                </div>
                                ${currentView === 'current' ? `
                                    <div>
                                        <p class="text-xs sm:text-sm text-gray-600">Budget</p>
                                        <p class="text-lg sm:text-2xl font-bold text-gray-900">$${monthlyBudget.toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs sm:text-sm text-gray-600">Remaining</p>
                                        <p class="text-lg sm:text-2xl font-bold ${budgetRemaining >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            $${Math.abs(budgetRemaining).toFixed(2)}
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            ${monthlyBudget > 0 ? ((budgetRemaining / monthlyBudget) * 100).toFixed(1) : 0}%
                                        </p>
                                    </div>
                                    <div>
                                        <p class="text-xs sm:text-sm text-gray-600">Days Left</p>
                                        <p class="text-lg sm:text-2xl font-bold text-gray-900">${getRemainingDaysInCycle()}</p>
                                    </div>
                                ` : `
                                    <div>
                                        <p class="text-xs sm:text-sm text-gray-600">Transactions</p>
                                        <p class="text-lg sm:text-2xl font-bold text-gray-900">${expenses.length}</p>
                                    </div>
                                `}
                            </div>

                            ${currentView === 'current' ? `
                                <div class="relative w-full bg-gray-200 rounded-full h-2 sm:h-3">
                                    <div class="absolute top-0 left-0 h-full rounded-full transition-all duration-300 ${
                                        budgetPercentage >= 100 ? 'bg-red-500' : 
                                        budgetPercentage >= 80 ? 'bg-yellow-500' : 'bg-green-500'
                                    }" style="width: ${Math.min(budgetPercentage, 100)}%"></div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- View Selector -->
                        <div class="flex flex-wrap gap-2 mb-4 sm:mb-6 overflow-x-auto mobile-scroll pb-2">
                            <button onclick="setView('current')" class="px-3 py-2 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-lg transition-colors ${currentView === 'current' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} touch-manipulation whitespace-nowrap">
                                Current Cycle
                            </button>
                            <div class="relative">
                                <button onclick="toggleDropdown('billingCycleDropdown')" class="px-3 py-2 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-lg transition-colors ${currentView === 'billingCycle' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} touch-manipulation whitespace-nowrap">
                                    Billing Cycle ▼
                                </button>
                                <div id="billingCycleDropdown" class="hidden absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border z-10 max-h-60 overflow-y-auto sm:min-w-[200px]">
                                    ${getAvailableBillingCycles().map(([cycleKey, cycleLabel]) => `
                                        <button onclick="setBillingCycle('${cycleKey}')" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 whitespace-nowrap">
                                            ${cycleLabel}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="relative">
                                <button onclick="toggleDropdown('monthDropdown')" class="px-3 py-2 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-lg transition-colors ${currentView === 'custom' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} touch-manipulation whitespace-nowrap">
                                    Month ▼
                                </button>
                                <div id="monthDropdown" class="hidden absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border z-10 max-h-60 overflow-y-auto sm:min-w-[200px]">
                                    ${getAvailableMonths().map(month => `
                                        <button onclick="setCustomMonth('${month}')" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 whitespace-nowrap">
                                            ${new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="relative">
                                <button onclick="toggleDropdown('yearDropdown')" class="px-3 py-2 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-lg transition-colors ${currentView === 'customYear' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'} touch-manipulation whitespace-nowrap">
                                    Year ▼
                                </button>
                                <div id="yearDropdown" class="hidden absolute top-full left-0 mt-1 bg-white rounded-lg shadow-lg border z-10 sm:min-w-[150px]">
                                    ${getAvailableYears().map(year => `
                                        <button onclick="setCustomYear(${year})" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                            ${year}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <button onclick="exportToCSV()" class="ml-auto px-3 py-2 sm:px-4 sm:py-2 text-xs sm:text-sm font-medium rounded-lg bg-white text-gray-700 hover:bg-gray-100 transition-colors touch-manipulation flex items-center gap-1 whitespace-nowrap">
                                Export CSV
                            </button>
                        </div>

                        <!-- Search and Filter -->
                        <div class="flex flex-col sm:flex-row gap-3 mb-4 sm:mb-6">
                            <div class="flex-1">
                                <input type="text" 
                                    placeholder="Search expenses..." 
                                    value="${searchQuery}"
                                    oninput="setSearch(this.value)"
                                    class="w-full px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                            </div>
                            <div class="relative">
                                <button onclick="document.getElementById('categoryFilter').classList.toggle('hidden')" 
                                    class="w-full sm:w-auto px-3 py-2 sm:px-4 sm:py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center justify-between sm:justify-center gap-2 text-sm sm:text-base touch-manipulation">
                                    <span>${selectedCategory ? categories.find(c => c.id === selectedCategory)?.name : 'All Categories'}</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div id="categoryFilter" class="hidden absolute top-full right-0 mt-1 bg-white rounded-lg shadow-lg border z-10 w-48">
                                    <button onclick="setCategory('')" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                        All Categories
                                    </button>
                                    ${categories.filter(cat => expenseCategories.includes(cat.id)).map(cat => `
                                        <button onclick="setCategory('${cat.id}')" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                            ${cat.emoji} ${cat.name}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                            <!-- Monthly Spending Trend -->
                            <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6">
                                <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">Monthly Spending Trend</h3>
                                <div class="chart-container">
                                    <canvas id="monthlyChart"></canvas>
                                </div>
                            </div>

                            <!-- Category Breakdown -->
                            <div class="bg-white rounded-xl shadow-sm border p-4 sm:p-6">
                                <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-4">Category Breakdown</h3>
                                <div class="chart-container">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Expenses List -->
                        <div class="bg-white rounded-xl shadow-sm border">
                            <div class="p-4 sm:p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-base sm:text-lg font-semibold text-gray-900">Recent Expenses</h3>
                                </div>

                                ${expenses.length === 0 ? `
                                    <div class="text-center py-8 sm:py-12 text-gray-500">
                                        <svg class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                        </svg>
                                        <p class="text-sm sm:text-base">No expenses found${searchQuery || selectedCategory ? ' for your search' : ''}</p>
                                        ${!searchQuery && !selectedCategory && currentView === 'current' ? `
                                            <button onclick="showAddExpense()" class="mt-4 text-blue-600 hover:text-blue-700 text-sm sm:text-base">
                                                Add your first expense
                                            </button>
                                        ` : ''}
                                    </div>
                                ` : `
                                    <div class="space-y-2 sm:space-y-3">
                                        ${expenses.map(expense => {
                                            const category = categories.find(c => c.id === expense.category) || { name: 'Unknown', emoji: '❓', color: 'bg-gray-500' };
                                            return `
                                                <div class="flex items-center gap-3 p-3 sm:p-4 rounded-lg hover:bg-gray-50 transition-colors group">
                                                    <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 ${category.color} rounded-full flex items-center justify-center">
                                                        <span class="text-lg sm:text-xl">${category.emoji}</span>
                                                    </div>
                                                    <div class="flex-1 min-w-0">
                                                        <div class="flex items-start justify-between gap-2">
                                                            <div class="flex-1 min-w-0">
                                                                <p class="font-medium text-gray-900 text-sm sm:text-base truncate">${expense.description}</p>
                                                                <div class="flex items-center gap-2 sm:gap-4 text-xs sm:text-sm text-gray-500">
                                                                    <span>${category.name}</span>
                                                                    <span>•</span>
                                                                    <span>${new Date(expense.date).toLocaleDateString()}</span>
                                                                    ${expense.isRefund ? '<span class="text-green-600 font-medium">Refund</span>' : ''}
                                                                </div>
                                                            </div>
                                                            <div class="flex items-center gap-1 sm:gap-2">
                                                                <span class="font-semibold text-gray-900 text-sm sm:text-base ${expense.isRefund ? 'text-green-600' : ''}">
                                                                    ${expense.isRefund ? '+' : '-'}$${expense.amount.toFixed(2)}
                                                                </span>
                                                                <button onclick="editExpense('${expense.id}')" class="sm:opacity-0 sm:group-hover:opacity-100 p-1.5 sm:p-1 hover:bg-gray-200 rounded transition-all touch-manipulation touch-target flex items-center justify-center">
                                                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                                    </svg>
                                                                </button>
                                                                <button onclick="handleDeleteExpense('${expense.id}')" class="sm:opacity-0 sm:group-hover:opacity-100 p-1.5 sm:p-1 hover:bg-red-100 rounded transition-all touch-manipulation touch-target flex items-center justify-center">
                                                                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Floating Action Button -->
                    <button onclick="showAddExpense()" class="fixed bottom-6 right-6 sm:bottom-8 sm:right-8 bg-blue-600 text-white p-4 sm:p-5 rounded-full shadow-lg hover:bg-blue-700 transition-all hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300">
                        <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </div>
            `;

            // Initialize charts
            setTimeout(() => renderCharts(), 100);
        }

        function renderCharts() {
            // Destroy existing charts
            if (charts.monthly) charts.monthly.destroy();
            if (charts.category) charts.category.destroy();

            // Monthly Spending Chart
            const monthlyCtx = document.getElementById('monthlyChart');
            if (monthlyCtx) {
                const monthlyData = getMonthlyData();
                const labels = Object.keys(monthlyData).map(key => {
                    const [year, month] = key.split('-');
                    return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short' });
                });

                charts.monthly = new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Monthly Spending',
                            data: Object.values(monthlyData),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Category Breakdown Chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                const categoryTotals = {};
                expenses.forEach(expense => {
                    if (!categoryTotals[expense.category]) {
                        categoryTotals[expense.category] = 0;
                    }
                    categoryTotals[expense.category] += expense.amount;
                });

                const sortedCategories = Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 6); // Top 6 categories

                charts.category = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCategories.map(([catId]) => {
                            const cat = categories.find(c => c.id === catId);
                            return cat ? cat.name : 'Unknown';
                        }),
                        datasets: [{
                            data: sortedCategories.map(([_, total]) => total),
                            backgroundColor: sortedCategories.map(([catId]) => {
                                const cat = categories.find(c => c.id === catId);
                                return cat ? cat.chartColor : '#6b7280';
                            })
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 10,
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        let isSignUp = false;

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            document.getElementById('authTitle').textContent = isSignUp ? 'Create your account' : 'Sign in to your account';
            document.getElementById('authButton').textContent = isSignUp ? 'Sign up' : 'Sign in';
            document.getElementById('authToggleText').textContent = isSignUp ? 'Already have an account?' : "Don't have an account?";
            document.getElementById('authToggleButton').textContent = isSignUp ? 'Sign in' : 'Sign up';
        }

        // Modal state
        let editingExpenseId = null;
        let expenseAmount = '';
        let expenseCategory = '';
        let expenseDescription = '';
        let expenseDate = new Date().toISOString().split('T')[0];
        let isRefund = false;

        function editExpense(expenseId) {
            const expense = allExpenses.find(e => e.id === expenseId);
            if (!expense) return;

            editingExpenseId = expenseId;
            expenseAmount = expense.amount.toString();
            expenseCategory = expense.category;
            expenseDescription = expense.description;
            expenseDate = new Date(expense.date).toISOString().split('T')[0];
            isRefund = expense.isRefund || false;

            showExpenseModal('Edit Expense');
        }

        function showAddExpense() {
            editingExpenseId = null;
            expenseAmount = '';
            expenseCategory = '';
            expenseDescription = '';
            expenseDate = new Date().toISOString().split('T')[0];
            isRefund = false;

            showExpenseModal('Add Expense');
        }

        function showExpenseModal(title) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50';
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            modal.innerHTML = `
                <div class="bg-white w-full sm:max-w-md sm:rounded-xl rounded-t-xl p-4 sm:p-6 animate-slide-up max-h-[90vh] overflow-y-auto mobile-scroll pb-safe">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                        <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Transaction Type Toggle -->
                    <div class="flex bg-gray-100 rounded-lg p-1 mb-4">
                        <button onclick="setTransactionType(false)" class="flex-1 py-2 rounded-md text-sm font-medium transition-colors ${!isRefund ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600'}">
                            Expense
                        </button>
                        <button onclick="setTransactionType(true)" class="flex-1 py-2 rounded-md text-sm font-medium transition-colors ${isRefund ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600'}">
                            Refund
                        </button>
                    </div>

                    <!-- Amount Display -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-4 text-center">
                        <div class="text-xs text-gray-600 mb-2">Amount</div>
                        <div class="text-5xl sm:text-3xl font-bold text-gray-900">
                            ${isRefund ? '+' : '-'}$<span id="amountDisplay">${expenseAmount || '0'}</span>
                        </div>
                    </div>

                    <!-- Category Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <div class="grid grid-cols-4 gap-2">
                            ${categories.map(cat => `
                                <button onclick="selectCategory('${cat.id}')" 
                                    class="p-3 rounded-lg border-2 transition-all ${expenseCategory === cat.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'} touch-manipulation">
                                    <div class="text-2xl mb-1">${cat.emoji}</div>
                                    <div class="text-xs text-gray-600">${cat.name}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <input type="text" 
                            id="descriptionInput"
                            value="${expenseDescription}"
                            oninput="expenseDescription = this.value"
                            placeholder="${isRefund ? 'Refund for...' : 'What did you spend on?'}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Date -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" 
                            value="${expenseDate}"
                            oninput="expenseDate = this.value"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- Number Pad -->
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        ${[1,2,3,4,5,6,7,8,9,'.',0,'⌫'].map(num => `
                            <button onclick="handleNumberPad('${num}')" 
                                class="py-5 sm:py-3 text-2xl sm:text-lg font-semibold bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation active:bg-gray-300 active:scale-95">
                                ${num}
                            </button>
                        `).join('')}
                    </div>

                    <button id="addExpenseBtn" onclick="handleAddExpense()" class="w-full bg-blue-500 text-white py-3 sm:py-4 rounded-xl font-semibold hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors mt-4 touch-manipulation">
                        ${editingExpenseId ? 'Update' : (isRefund ? 'Add Refund' : 'Add Expense')}
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function setTransactionType(refund) {
            isRefund = refund;
            // Update the UI without recreating the modal
            const expenseBtn = document.querySelector('[onclick="setTransactionType(false)"]');
            const refundBtn = document.querySelector('[onclick="setTransactionType(true)"]');
            
            if (expenseBtn && refundBtn) {
                if (refund) {
                    expenseBtn.className = "flex-1 py-2 rounded-md text-sm font-medium transition-colors text-gray-600";
                    refundBtn.className = "flex-1 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm";
                } else {
                    expenseBtn.className = "flex-1 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm";
                    refundBtn.className = "flex-1 py-2 rounded-md text-sm font-medium transition-colors text-gray-600";
                }
            }
            
            // Update the amount display sign
            const amountDisplay = document.getElementById('amountDisplay');
            if (amountDisplay && amountDisplay.parentElement) {
                const signSpan = amountDisplay.parentElement;
                signSpan.innerHTML = `${refund ? '+' : '-'}$<span id="amountDisplay">${expenseAmount || '0'}</span>`;
            }
            
            // Update the description placeholder
            const descInput = document.getElementById('descriptionInput');
            if (descInput) {
                descInput.placeholder = refund ? 'Refund for...' : 'What did you spend on?';
            }
            
            // Update the button text
            const addBtn = document.getElementById('addExpenseBtn');
            if (addBtn && !editingExpenseId) {
                addBtn.textContent = refund ? 'Add Refund' : 'Add Expense';
            }
        }

        function selectCategory(catId) {
            expenseCategory = catId;
            // Update the UI to show selected category without recreating the modal
            document.querySelectorAll('[onclick^="selectCategory"]').forEach(btn => {
                const btnCatId = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (btnCatId === catId) {
                    btn.className = "p-3 rounded-lg border-2 transition-all border-blue-500 bg-blue-50 touch-manipulation";
                } else {
                    btn.className = "p-3 rounded-lg border-2 transition-all border-gray-200 hover:border-gray-300 touch-manipulation";
                }
            });
        }

        function handleNumberPad(value) {
            if (value === '⌫') {
                expenseAmount = expenseAmount.slice(0, -1);
            } else if (value === '.' && !expenseAmount.includes('.')) {
                expenseAmount += value;
            } else if (value !== '.') {
                // Limit to 2 decimal places
                const parts = expenseAmount.split('.');
                if (parts.length === 2 && parts[1].length >= 2) {
                    return;
                }
                // Limit total length to prevent overflow
                if (expenseAmount.length < 10) {
                    expenseAmount += value;
                }
            }
            updateAmountDisplay();
            
            // Add haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(10);
            }
        }

        function updateAmountDisplay() {
            const display = document.getElementById('amountDisplay');
            if (display) {
                display.textContent = expenseAmount || '0';
                // Scale font size if number gets too long
                if (expenseAmount.length > 7) {
                    display.parentElement.classList.remove('text-5xl');
                    display.parentElement.classList.add('text-4xl');
                } else {
                    display.parentElement.classList.remove('text-4xl');
                    display.parentElement.classList.add('text-5xl');
                }
            }
        }

        async function handleAddExpense() {
            // Get the current description value from the input field
            const descInput = document.getElementById('descriptionInput');
            if (descInput) {
                expenseDescription = descInput.value;
            }
            
            if (!expenseAmount || parseFloat(expenseAmount) === 0 || !expenseCategory || !currentUser) {
                console.error('Cannot add expense:', {
                    expenseAmount,
                    expenseCategory,
                    currentUser: currentUser ? 'exists' : 'missing'
                });
                if (!expenseAmount || parseFloat(expenseAmount) === 0) {
                    showBudgetNotification('danger', 'Please enter an amount');
                } else if (!expenseCategory) {
                    showBudgetNotification('danger', 'Please select a category');
                } else if (!currentUser) {
                    showBudgetNotification('danger', 'Please sign in to add expenses');
                }
                return;
            }
            
            const btn = document.getElementById('addExpenseBtn');
            const isEditing = editingExpenseId !== null;
            
            btn.textContent = isEditing ? 'Updating...' : (isRefund ? 'Adding Refund...' : 'Adding...');
            btn.disabled = true;
            
            try {
                const expenseData = {
                    amount: parseFloat(expenseAmount),
                    category: expenseCategory,
                    description: expenseDescription || (isRefund ? 'Refund' : 'Expense'),
                    date: Timestamp.fromDate(new Date(expenseDate + 'T12:00:00')),
                    isRefund: isRefund,
                    userId: currentUser.uid
                };

                if (isEditing) {
                    await updateDoc(doc(db, 'expenses', editingExpenseId), expenseData);
                    showBudgetNotification('success', 'Expense updated successfully!');
                } else {
                    await addDoc(collection(db, 'expenses'), expenseData);
                    showBudgetNotification('success', isRefund ? 'Refund added successfully!' : 'Expense added successfully!');
                }
                
                closeModal();
            } catch (error) {
                console.error('Error saving expense:', error);
                showBudgetNotification('danger', 'Failed to save. Please try again.');
                btn.textContent = isEditing ? 'Update' : (isRefund ? 'Add Refund' : 'Add Expense');
                btn.disabled = false;
            }
        }

        function closeModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) modal.remove();
        }

        function showBudgetModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 sm:p-4';
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-t-xl sm:rounded-xl p-6 max-w-md w-full pb-safe animate-slide-up sm:animate-none">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Budget Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Budget</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                <input type="number" 
                                    id="budgetInput"
                                    value="${monthlyBudget}"
                                    class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Credit Card Closing Day</label>
                            <select id="billingDayInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                ${Array.from({length: 31}, (_, i) => i + 1).map(day => `
                                    <option value="${day}" ${day === billingCycleDay ? 'selected' : ''}>
                                        ${day}${day === 1 ? 'st' : day === 2 ? 'nd' : day === 3 ? 'rd' : 'th'} of each month
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <strong>Note:</strong> Your billing cycle runs from the ${billingCycleDay + 1}${billingCycleDay === 0 ? 'st' : billingCycleDay === 1 ? 'nd' : billingCycleDay === 2 ? 'rd' : 'th'} 
                                to the ${billingCycleDay}${billingCycleDay === 1 ? 'st' : billingCycleDay === 2 ? 'nd' : billingCycleDay === 3 ? 'rd' : 'th'} of each month.
                            </p>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button onclick="closeModal()" class="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="saveBudget()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" id="saveBudgetBtn">
                            Save Changes
                        </button>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <button onclick="showMasterResetModal()" class="w-full py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors">
                            Reset All Data
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function saveBudget() {
            const newBudget = parseFloat(document.getElementById('budgetInput').value);
            const newBillingDay = parseInt(document.getElementById('billingDayInput').value);
            const btn = document.getElementById('saveBudgetBtn');
            
            if (isNaN(newBudget) || newBudget <= 0) {
                showBudgetNotification('danger', 'Please enter a valid budget amount');
                return;
            }
            
            btn.textContent = 'Saving...';
            btn.disabled = true;
            
            try {
                await setDoc(doc(db, 'userSettings', currentUser.uid), {
                    monthlyBudget: newBudget,
                    billingCycleDay: newBillingDay
                });
                
                showBudgetNotification('success', 'Budget settings updated successfully!');
                closeModal();
            } catch (error) {
                console.error('Error saving budget:', error);
                showBudgetNotification('danger', 'Failed to save settings. Please try again.');
                btn.textContent = 'Save Changes';
                btn.disabled = false;
            }
        }

        async function handleResetBilling() {
            if (!confirm('This will reset your billing cycle to start from today. Are you sure?')) return;
            
            try {
                const today = new Date();
                const newCycleStart = today.toISOString().split('T')[0];
                
                await setDoc(doc(db, 'userSettings', currentUser.uid), {
                    monthlyBudget: monthlyBudget,
                    billingCycleDay: today.getDate() - 1,
                    billingCycleStart: newCycleStart
                }, { merge: true });
                
                filterAndRender();
                showBudgetNotification('success', 'Billing cycle updated successfully!');
            } catch (error) {
                console.error('Error resetting billing cycle:', error);
                showBudgetNotification('danger', 'Failed to reset billing cycle. Please try again.');
            }
        }

        async function handleDeleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            
            try {
                await deleteDoc(doc(db, 'expenses', expenseId));
                showBudgetNotification('success', 'Expense deleted successfully!');
            } catch (error) {
                console.error('Error deleting expense:', error);
                showBudgetNotification('danger', 'Failed to delete expense. Please try again.');
            }
        }

        let masterResetConfirmation = '';

        function showMasterResetModal() {
            masterResetConfirmation = '';
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 sm:p-4';
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-t-xl sm:rounded-xl p-6 max-w-md w-full pb-safe animate-slide-up sm:animate-none">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">Reset All Data</h3>
                        <p class="text-gray-600 mb-4">This will permanently delete all your expenses and settings. This action cannot be undone.</p>
                        
                        <div class="bg-red-50 p-4 rounded-lg mb-4">
                            <p class="text-sm text-red-800 font-medium">Type "DELETE ALL" to confirm:</p>
                        </div>
                        
                        <input type="text" 
                            id="resetConfirmInput"
                            oninput="checkDeleteConfirmation()"
                            placeholder="Type DELETE ALL"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 mb-4">
                    </div>

                    <div class="flex gap-3">
                        <button onclick="closeModal()" class="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button 
                            id="confirmResetBtn"
                            onclick="handleMasterReset()" 
                            disabled
                            class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                            Reset Everything
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function checkDeleteConfirmation() {
            const input = document.getElementById('resetConfirmInput');
            const btn = document.getElementById('confirmResetBtn');
            masterResetConfirmation = input.value;
            btn.disabled = masterResetConfirmation !== 'DELETE ALL';
        }

        async function handleMasterReset() {
            if (masterResetConfirmation !== 'DELETE ALL') return;
            
            const btn = document.getElementById('confirmResetBtn');
            btn.textContent = 'Resetting...';
            btn.disabled = true;
            
            try {
                // Delete all expenses
                const expensesQuery = query(collection(db, 'expenses'), where('userId', '==', currentUser.uid));
                const snapshot = await getDocs(expensesQuery);
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                
                // Delete user settings
                await deleteDoc(doc(db, 'userSettings', currentUser.uid));
                
                // Delete user categories
                await deleteDoc(doc(db, 'userCategories', currentUser.uid));
                
                showBudgetNotification('success', 'All data has been reset successfully!');
                closeModal();
                
                // Reset local state
                allExpenses = [];
                expenses = [];
                monthlyBudget = 2000;
                billingCycleDay = 11;
                billingCycleStart = new Date().toISOString().split('T')[0];
                categories = [...defaultCategories];
                
                // Re-subscribe to get fresh data
                subscribeToUserData();
            } catch (error) {
                console.error('Error resetting data:', error);
                showBudgetNotification('danger', 'Failed to reset data. Please try again.');
                btn.textContent = 'Reset Everything';
                btn.disabled = false;
            }
        }

        function showCategoryManager() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 sm:p-4';
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">Manage Categories</h3>
                        <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <button onclick="showAddCategory()" class="w-full mb-4 py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 transition-colors">
                        <div class="flex items-center justify-center gap-2 text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            <span>Add New Category</span>
                        </div>
                    </button>

                    <div class="space-y-2">
                        ${categories.map((cat, index) => `
                            <div class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors">
                                <div class="w-12 h-12 ${cat.color} rounded-full flex items-center justify-center">
                                    <span class="text-xl">${cat.emoji}</span>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-900">${cat.name}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="editCategory(${index})" class="p-2 hover:bg-gray-200 rounded-lg transition-all">
                                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    ${categories.length > 1 ? `
                                        <button onclick="deleteCategory(${index})" class="p-2 hover:bg-red-100 rounded-lg transition-all">
                                            <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        let newCategoryEmoji = '📦';
        let newCategoryName = '';
        let newCategoryColor = 0;

        const availableColors = [
            'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500',
            'bg-lime-500', 'bg-green-500', 'bg-emerald-500', 'bg-teal-500',
            'bg-cyan-500', 'bg-sky-500', 'bg-blue-500', 'bg-indigo-500',
            'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 'bg-pink-500'
        ];

        const chartColors = [
            '#ef4444', '#f97316', '#f59e0b', '#eab308',
            '#84cc16', '#22c55e', '#10b981', '#14b8a6',
            '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1',
            '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'
        ];

        const availableEmojis = [
            '🍔', '🍕', '🍜', '☕', '🛒', '🚗', '🚕', '✈️',
            '🏠', '💡', '📱', '💻', '👕', '👟', '🎮', '🎬',
            '🎵', '📚', '💊', '🏥', '💪', '🎁', '🎉', '📦'
        ];

        function showAddCategory() {
            newCategoryEmoji = '📦';
            newCategoryName = '';
            newCategoryColor = Math.floor(Math.random() * availableColors.length);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 sm:p-4';
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-t-xl sm:rounded-xl p-6 max-w-md w-full pb-safe animate-slide-up sm:animate-none">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Add New Category</h3>
                    
                    <div class="space-y-4">
                        <!-- Emoji Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Choose an emoji</label>
                            <div class="grid grid-cols-8 gap-2 mb-4 p-3 bg-gray-50 rounded-lg max-h-40 overflow-y-auto">
                                ${availableEmojis.map(emoji => `
                                    <button onclick="selectEmoji('${emoji}')" 
                                        class="p-2 text-2xl hover:bg-white rounded transition-all ${newCategoryEmoji === emoji ? 'bg-white shadow-sm ring-2 ring-blue-500' : ''}">
                                        ${emoji}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Name Input -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category name</label>
                            <input type="text" 
                                id="categoryNameInput"
                                placeholder="Enter category name"
                                oninput="newCategoryName = this.value"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Color Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Choose a color</label>
                            <div class="grid grid-cols-8 gap-2">
                                ${availableColors.map((color, index) => `
                                    <button onclick="selectColor(${index})" 
                                        class="h-8 ${color} rounded transition-all ${newCategoryColor === index ? 'ring-2 ring-offset-2 ring-gray-800' : ''}">
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Preview -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Preview:</p>
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 ${availableColors[newCategoryColor]} rounded-full flex items-center justify-center">
                                    <span class="text-xl">${newCategoryEmoji}</span>
                                </div>
                                <p class="font-medium text-gray-900" id="categoryPreviewName">${newCategoryName || 'Category Name'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button onclick="closeModal()" class="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="saveNewCategory()" class="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" id="saveCategoryBtn">
                            Add Category
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function selectEmoji(emoji) {
            newCategoryEmoji = emoji;
            showAddCategory();
        }

        function selectColor(index) {
            newCategoryColor = index;
            showAddCategory();
        }

        async function saveNewCategory() {
            // Get the current value from the input field
            const nameInput = document.getElementById('categoryNameInput');
            if (nameInput) {
                newCategoryName = nameInput.value;
            }
            
            if (!newCategoryName.trim()) {
                showBudgetNotification('danger', 'Please enter a category name');
                return;
            }

            const btn = document.getElementById('saveCategoryBtn');
            btn.textContent = 'Adding...';
            btn.disabled = true;

            try {
                const newCategory = {
                    id: `custom_${Date.now()}`,
                    name: newCategoryName.trim(),
                    emoji: newCategoryEmoji,
                    color: availableColors[newCategoryColor],
                    chartColor: chartColors[newCategoryColor]
                };

                const updatedCategories = [...categories, newCategory];
                
                await setDoc(doc(db, 'userCategories', currentUser.uid), {
                    categories: updatedCategories
                });

                showBudgetNotification('success', 'Category added successfully!');
                closeModal();
                showCategoryManager();
            } catch (error) {
                console.error('Error adding category:', error);
                showBudgetNotification('danger', 'Failed to add category. Please try again.');
                btn.textContent = 'Add Category';
                btn.disabled = false;
            }
        }

        async function editCategory(index) {
            const category = categories[index];
            newCategoryEmoji = category.emoji;
            newCategoryName = category.name;
            newCategoryColor = availableColors.indexOf(category.color);

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-end sm:items-center justify-center z-50 sm:p-4';
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            
            modal.innerHTML = `
                <div class="bg-white rounded-t-xl sm:rounded-xl p-6 max-w-md w-full pb-safe animate-slide-up sm:animate-none">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Edit Category</h3>
                    
                    <div class="space-y-4">
                        <!-- Emoji Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Choose an emoji</label>
                            <div class="grid grid-cols-8 gap-2 mb-4 p-3 bg-gray-50 rounded-lg max-h-40 overflow-y-auto">
                                ${availableEmojis.map(emoji => `
                                    <button onclick="selectEmoji('${emoji}'); editCategory(${index})" 
                                        class="p-2 text-2xl hover:bg-white rounded transition-all ${newCategoryEmoji === emoji ? 'bg-white shadow-sm ring-2 ring-blue-500' : ''}">
                                        ${emoji}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Name Input -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category name</label>
                            <input type="text" 
                                value="${newCategoryName}"
                                oninput="newCategoryName = this.value"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- Color Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Choose a color</label>
                            <div class="grid grid-cols-8 gap-2">
                                ${availableColors.map((color, colorIndex) => `
                                    <button onclick="selectColor(${colorIndex}); editCategory(${index})" 
                                        class="h-8 ${color} rounded transition-all ${newCategoryColor === colorIndex ? 'ring-2 ring-offset-2 ring-gray-800' : ''}">
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button onclick="closeModal(); showCategoryManager()" class="flex-1 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="updateCategory(${index})" class="flex-1 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" id="updateCategoryBtn">
                            Update Category
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function updateCategory(index) {
            if (!newCategoryName.trim()) {
                showBudgetNotification('danger', 'Please enter a category name');
                return;
            }

            const btn = document.getElementById('updateCategoryBtn');
            btn.textContent = 'Updating...';
            btn.disabled = true;

            try {
                const updatedCategories = [...categories];
                updatedCategories[index] = {
                    ...updatedCategories[index],
                    name: newCategoryName.trim(),
                    emoji: newCategoryEmoji,
                    color: availableColors[newCategoryColor],
                    chartColor: chartColors[newCategoryColor]
                };
                
                await setDoc(doc(db, 'userCategories', currentUser.uid), {
                    categories: updatedCategories
                });

                showBudgetNotification('success', 'Category updated successfully!');
                closeModal();
                showCategoryManager();
            } catch (error) {
                console.error('Error updating category:', error);
                showBudgetNotification('danger', 'Failed to update category. Please try again.');
                btn.textContent = 'Update Category';
                btn.disabled = false;
            }
        }

        async function deleteCategory(index) {
            const category = categories[index];
            
            // Check if category is in use
            const categoryInUse = allExpenses.some(exp => exp.category === category.id);
            
            if (categoryInUse) {
                showBudgetNotification('warning', 'Cannot delete category that has expenses. Delete or reassign expenses first.');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${category.name}"?`)) return;

            try {
                const updatedCategories = categories.filter((_, i) => i !== index);
                
                await setDoc(doc(db, 'userCategories', currentUser.uid), {
                    categories: updatedCategories
                });

                showBudgetNotification('success', 'Category deleted successfully!');
                showCategoryManager();
            } catch (error) {
                console.error('Error deleting category:', error);
                showBudgetNotification('danger', 'Failed to delete category. Please try again.');
            }
        }

        function setView(view) {
            currentView = view;
            selectedMonth = null;
            selectedYear = null;
            selectedBillingCycle = null;
            filterAndRender();
        }

        function setCustomMonth(monthKey) {
            currentView = 'custom';
            selectedMonth = monthKey;
            selectedYear = null;
            selectedBillingCycle = null;
            document.getElementById('monthDropdown').classList.add('hidden');
            filterAndRender();
        }

        function setCustomYear(year) {
            currentView = 'customYear';
            selectedMonth = null;
            selectedYear = year;
            selectedBillingCycle = null;
            document.getElementById('yearDropdown').classList.add('hidden');
            filterAndRender();
        }

        function setBillingCycle(cycleStartDate) {
            currentView = 'billingCycle';
            selectedMonth = null;
            selectedYear = null;
            selectedBillingCycle = cycleStartDate;
            document.getElementById('billingCycleDropdown').classList.add('hidden');
            filterAndRender();
        }

        function setSearch(query) {
            searchQuery = query;
            filterAndRender();
        }

        function setCategory(category) {
            selectedCategory = category;
            document.getElementById('categoryFilter').classList.add('hidden');
            filterAndRender();
        }

        function exportToCSV() {
            const headers = ['Date', 'Description', 'Category', 'Amount', 'Type'];
            const rows = expenses.map(expense => {
                const category = categories.find(c => c.id === expense.category);
                return [
                    new Date(expense.date).toLocaleDateString(),
                    expense.description,
                    category ? category.name : 'Unknown',
                    expense.amount.toFixed(2),
                    expense.isRefund ? 'Refund' : 'Expense'
                ];
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `credit-card-expenses-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        // Make functions available globally
        window.handleGoogleSignIn = handleGoogleSignIn;
        window.handleAuth = handleAuth;
        window.handleLogout = handleLogout;
        window.toggleAuthMode = toggleAuthMode;
        window.setView = setView;
        window.setCustomMonth = setCustomMonth;
        window.setCustomYear = setCustomYear;
        window.setBillingCycle = setBillingCycle;
        window.setSearch = setSearch;
        window.setCategory = setCategory;
        window.editExpense = editExpense;
        window.showAddExpense = showAddExpense;
        window.showExpenseModal = showExpenseModal;
        window.setTransactionType = setTransactionType;
        window.selectCategory = selectCategory;
        window.handleNumberPad = handleNumberPad;
        window.updateAmountDisplay = updateAmountDisplay;
        window.handleAddExpense = handleAddExpense;
        window.closeModal = closeModal;
        window.showBudgetModal = showBudgetModal;
        window.saveBudget = saveBudget;
        window.handleResetBilling = handleResetBilling;
        window.handleDeleteExpense = handleDeleteExpense;
        window.showMasterResetModal = showMasterResetModal;
        window.checkDeleteConfirmation = checkDeleteConfirmation;
        window.handleMasterReset = handleMasterReset;
        window.showCategoryManager = showCategoryManager;
        window.showAddCategory = showAddCategory;
        window.selectEmoji = selectEmoji;
        window.selectColor = selectColor;
        window.saveNewCategory = saveNewCategory;
        window.editCategory = editCategory;
        window.updateCategory = updateCategory;
        window.deleteCategory = deleteCategory;
        window.exportToCSV = exportToCSV;

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            const errorDiv = document.getElementById('errorMessage');
            
            try {
                await signInWithPopup(auth, provider);
                errorDiv.innerHTML = '';
            } catch (error) {
                console.error('Google sign-in error:', error);
                let message = 'Failed to sign in with Google';
                if (error.code === 'auth/popup-closed-by-user') {
                    message = 'Sign-in cancelled';
                } else if (error.code === 'auth/popup-blocked') {
                    message = 'Pop-up blocked. Please allow pop-ups for this site.';
                }
                
                errorDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-sm">${message}</span>
                    </div>
                `;
            }
        }

        async function handleAuth(event, isSignUp) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('errorMessage');
            
            try {
                if (isSignUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                errorDiv.innerHTML = '';
            } catch (error) {
                let message = 'An error occurred';
                if (error.code === 'auth/email-already-in-use') message = 'Email already in use';
                else if (error.code === 'auth/weak-password') message = 'Password is too weak';
                else if (error.code === 'auth/invalid-email') message = 'Invalid email address';
                else if (error.code === 'auth/user-not-found') message = 'No account found with this email';
                else if (error.code === 'auth/wrong-password') message = 'Incorrect password';
                else if (error.code === 'auth/invalid-credential') message = 'Invalid email or password';
                
                errorDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-sm">${message}</span>
                    </div>
                `;
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Mobile-friendly dropdown toggle
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const isMobile = window.innerWidth < 640;
            
            // Close other dropdowns
            ['billingCycleDropdown', 'monthDropdown', 'yearDropdown'].forEach(id => {
                if (id !== dropdownId) {
                    document.getElementById(id).classList.add('hidden');
                }
            });
            
            // Remove any existing overlays
            const existingOverlay = document.querySelector('.dropdown-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                
                if (isMobile) {
                    // Add overlay for mobile
                    const overlay = document.createElement('div');
                    overlay.className = 'dropdown-overlay';
                    overlay.onclick = () => {
                        dropdown.classList.add('hidden');
                        overlay.remove();
                    };
                    document.body.appendChild(overlay);
                    
                    // Make dropdown mobile-friendly
                    dropdown.classList.add('dropdown-mobile', 'mobile-scroll');
                } else {
                    dropdown.classList.remove('dropdown-mobile', 'mobile-scroll');
                }
            } else {
                dropdown.classList.add('hidden');
            }
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                ['billingCycleDropdown', 'monthDropdown', 'yearDropdown'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            }
        });
    </script>
</body>
</html>